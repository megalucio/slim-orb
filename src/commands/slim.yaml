description: |
  Slim one or more Docker images and generate security profiles.
  You can pass additional SlimToolkit global options using the 'global_options' parameter.
  For all possible options, see:
  https://github.com/slimtoolkit/slim?tab=readme-ov-file#usage-details
  You can pass additional SlimToolkit build command options using the 'build_options' parameter.
  For all possible options, see:
  https://github.com/slimtoolkit/slim?tab=readme-ov-file#build-command-options
parameters:
  images:
    type: string
    description: Comma-separated list of image names (e.g. "nginx,alpine")
  tag:
    type: string
    description: Tag to use for all input images
  repo:
    type: string
    default: ""
    description: Optional repo to prepend to each image name (e.g. "myrepo/")
  output_tag:
    type: string
    default: ""
    description: Tag to use for all output images (e.g. "slim" will produce nginx:slim). If not set, uses "slim.<tag>"
  setup_docker:
    type: boolean
    default: false
    description: Whether to set up remote Docker for image processing
  build_options:
    type: string
    default: ""
    description: Additional SlimToolkit build command options (see https://github.com/slimtoolkit/slim?tab=readme-ov-file#build-command-options)
  global_options:
    type: string
    default: ""
    description: Additional global options for the SlimToolkit command (see https://github.com/slimtoolkit/slim?tab=readme-ov-file#usage-details)
  push_images:
    type: boolean
    default: false
    description: Whether to push the resulting images to the remote registry after building
steps:
  - when:
      condition: << parameters.setup_docker >>
      steps:
        - setup_remote_docker:
            docker_layer_caching: true
  - run:
      name: Install SlimToolkit
      command: |
        curl -sL https://raw.githubusercontent.com/slimtoolkit/slim/master/scripts/install-slim.sh | sudo -E bash -
  - run:
      name: Slim Docker images and generate profiles
      shell: /usr/bin/env bash -eo pipefail
      command: |
        export SLIM_ORB_IMAGES="${SLIM_ORB_IMAGES}"
        export SLIM_ORB_TAG="${SLIM_ORB_TAG}"
        export SLIM_ORB_REPO="${SLIM_ORB_REPO}"
        export SLIM_ORB_OUTPUT_TAG="${SLIM_ORB_OUTPUT_TAG}"
        export SLIM_ORB_BUILD_OPTIONS="${SLIM_ORB_BUILD_OPTIONS}"
        export SLIM_ORB_GLOBAL_OPTIONS="${SLIM_ORB_GLOBAL_OPTIONS}"
        export SLIM_ORB_PUSH_IMAGES="${SLIM_ORB_PUSH_IMAGES}"
        # Override with parameter if set (non-empty)
        if [ -n "<< parameters.images >>" ]; then export SLIM_ORB_IMAGES="<< parameters.images >>"; fi
        if [ -n "<< parameters.tag >>" ]; then export SLIM_ORB_TAG="<< parameters.tag >>"; fi
        if [ -n "<< parameters.repo >>" ]; then export SLIM_ORB_REPO="<< parameters.repo >>"; fi
        if [ -n "<< parameters.output_tag >>" ]; then export SLIM_ORB_OUTPUT_TAG="<< parameters.output_tag >>"; fi
        if [ -n "<< parameters.build_options >>" ]; then export SLIM_ORB_BUILD_OPTIONS="<< parameters.build_options >>"; fi
        if [ -n "<< parameters.global_options >>" ]; then export SLIM_ORB_GLOBAL_OPTIONS="<< parameters.global_options >>"; fi
        if [ -n "<< parameters.push_images >>" ]; then export SLIM_ORB_PUSH_IMAGES="<< parameters.push_images >>"; fi
        python3 src/scripts/slim.py
  - persist_to_workspace:
      root: workspace
      paths:
        - .
