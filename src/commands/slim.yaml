description: Slim a Docker image and generate security profiles
parameters:
  image:
    type: string
  tag:
    type: string
    default: "latest"
  output_image:
    type: string
    default: ""
  use_remote_docker:
    type: boolean
    default: true
steps:
  - when:
      condition: << parameters.use_remote_docker >>
      steps:
        - setup_remote_docker:
            docker_layer_caching: true
  - run:
      name: Install SlimToolkit
      command: |
        curl -sL https://raw.githubusercontent.com/slimtoolkit/slim/master/scripts/install-slim.sh | sudo -E bash -
  - run:
      name: Slim Docker image and generate profiles
      command: |
        slim build --copy-meta-artifacts . --target << parameters.image >>:<< parameters.tag >> --tag << parameters.output_image >>
  - run:
      name: Move AppArmor and Seccomp profiles if they exist
      command: |
        mkdir -p workspace
        if [ -f "<< parameters.image >>-apparmor-profile" ]; then
          mv "<< parameters.image >>-apparmor-profile" workspace/
        fi
        if [ -f "<< parameters.image >>-seccomp.json" ]; then
          mv "<< parameters.image >>-seccomp.json" workspace/
        fi
  - persist_to_workspace:
      root: workspace
      paths:
        - << parameters.image >>-apparmor-profile
        - << parameters.image >>-seccomp.json
